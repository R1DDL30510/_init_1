# Secure Home Systems Runbook

This runbook is the operational companion to the repository atlas in [`README.md`](README.md). It references the same automation targets defined in the `Makefile` while pointing to authoritative documentation for architecture, security, and audit scoring.

## Prerequisites
- Docker Engine 24+ with compose plugin and access to the host Docker socket.
- Host packages: OpenSSL, `zstd`, `jq`, `age`, and `psql` as recorded in [`fundament/versions.yaml`](fundament/versions.yaml).
- Local secrets populated in `.env.local` using `.env.example` as a template; never commit credentials.

## Bootstrap Checklist
- [ ] Launch the Dev Container (`.devcontainer/devcontainer.json`) or prepare equivalent host tooling.
- [ ] Review `.env.example` and pre-stage required secrets so the subsequent bootstrap can copy them into `.env.local`.
- [ ] Execute `make bootstrap` to automatically:
    - [ ] generate deterministic CA and leaf certificates via `scripts/tls/gen_local_ca.sh`,
    - [ ] scaffold `logs/` and `backups/`,
    - [ ] copy `.env.example` into `.env.local` when absent.
- [ ] Validate `VERSIONS.lock` contains the intended image tags, digests, and model metadata referenced by `compose.yaml` and service configs.
- [ ] Capture the resulting console output and generated files as baseline evidence for future delete and recovery drills.

## TLS Asset Primer
- The bootstrap step produces a minimal certificate authority (`secrets/tls/ca.*`) and a single leaf certificate (`secrets/tls/leaf.*`). Both assets are deterministic so they can be safely regenerated on demand without conflicting fingerprints.
- The CA materials sign local TLS endpoints (gateway, services, and acceptance probes). They are generated by `scripts/tls/gen_local_ca.sh` during `make bootstrap` and whenever you run `make ca.rotate`.
- The leaf certificate enables mutual TLS between the proxy and the internal services. It is derived immediately after the CA is created and is replaced alongside it during rotations. The PEM files are consumed by Docker secrets, while DER exports are available for client tooling.
- To export a workstation-friendly bundle, run `scripts/tls/export_client_bundle.sh` after bootstrap. The script collects the CA certificate, leaf certificate, and private key into `secrets/tls/client/` so browsers and API clients can establish trust.

## TLS Fingerprint Verification
- [ ] After generating certificates, record the expected SHA-256 fingerprint for the leaf certificate:
    - [ ] `openssl x509 -in secrets/tls/leaf.pem -noout -fingerprint -sha256 > secrets/tls/leaf.sha256`
- [ ] Provide the baseline to `scripts/status.sh` by either:
    - [ ] setting `SHS_TLS_LEAF_FINGERPRINT_SHA256` in `.env.local`, or
    - [ ] setting `SHS_TLS_LEAF_FINGERPRINT_FILE` to the fingerprint file path (defaults to `secrets/tls/leaf.sha256`).
- [ ] Run `make status` to confirm the observed fingerprint matches the expected baseline before promoting artifacts.
- [ ] Archive the fingerprint file alongside backup evidence so destructive delete tests can assert the regenerated values.

## Lifecycle Commands
| Action | Command | Notes |
| --- | --- | --- |
| Start services | `make up` | Defaults to the `minimal` profile; pass `PROFILE=gpu` to target the GPU overlay. |
| Stop services | `make down` | Leaves persistent volumes intact; use `docker compose down -v` manually for destructive cleanup. |
| Status summary | `make status` | Calls `scripts/status.sh` to report HTTPS endpoints, enabled profiles, health probes, and TLS fingerprint validation. |
| Acceptance suite | `make test` | Runs all scripts under `tests/acceptance/` with trace-aware JSON logging. |
| Rotate CA | `make ca.rotate` | Forces deterministic regeneration of CA/leaf materials; rerun `make up` afterwards. |
| Backup | `make backup` | Produces `backups/shs-<timestamp>.tar.zst` containing TLS, logs, versions, and a Postgres dump. |
| Restore | `make restore ARCHIVE=...` | Stops services, restores archive content, and replays database dump. |
| Clean | `make clean` | Removes generated TLS assets, logs, backups, and the local env file. |

## Service Configuration Reference
- `services/ocr/config.yaml`: Controls the OCR microservice (`host`, `port`, trace header, supported languages, and Doctr model pin). Tune `processing.max_pages` cautiously to maintain deterministic resource usage.
- `services/tei/config.yaml`: TEI embeddings server (`BAAI/bge-small-en`), worker count, timeout, and trace header alignment. Ensure revisions remain synchronized with `VERSIONS.lock` before regenerating embeddings.
- `services/reranker/config.yaml`: Semantic reranker profile with top-K scoring limit (`BAAI/bge-reranker-base`). Adjustments should land alongside acceptance-test updates.
- `openwebui/` and other service directories inherit configuration from `.env.local`; document overrides in `docs/project-compendium.md` when introducing new keys.

## Acceptance Testing
- Follow the execution order defined in `tests/acceptance/*.sh`; each script logs to `logs/shs.jsonl` with a dedicated `trace_id`.
- The suite asserts TLS-only proxy availability, ingest idempotency, semantic retrieval with ≥3 citations, SQL accuracy, sync reconciliation, and resilience retry paths.
- Reference [`docs/audit-matrix.md`](docs/audit-matrix.md) to map each test to the associated compliance principle.

## GA-02 Delete Playbook Attachment
- [ ] Review the appendix at [`docs/runbook-ga-02-delete-playbook.md`](docs/runbook-ga-02-delete-playbook.md) before executing destructive operations.
- [ ] Rehearse the dry-run path of the automated delete test to ensure network access, credentials, and log directories are ready.
- [ ] Capture live evidence (console output, log excerpts, and TLS fingerprint deltas) when you perform the real delete rehearsal.
- [ ] File the captured evidence in the shared incident ledger referenced by `SECURITY.md` so auditors can trace the deletion lifecycle.

## Backup & Restore Procedures
1. Ensure services are healthy (`make status`).
2. Run `make backup` and store the resulting archive offline.
3. For restoration, provide the archive path: `make restore ARCHIVE=backups/shs-<timestamp>.tar.zst`.
4. After restore, execute `make up` followed by `make status` to confirm certificates, digests, and health checks align with `README.md` expectations.

## Incident Response Checklist
- Immediately restrict access by tightening `LAN_ALLOWLIST` in `.env.local` and re-running `make up`.
- Rotate certificates (`make ca.rotate`) and regenerate secrets as necessary.
- Capture evidentiary logs (`cp logs/shs.jsonl incident-<timestamp>.jsonl`) and verify database integrity with the SQL probes documented in [`db/policies.sql`](db/policies.sql).
- Use the control matrix in [`SECURITY.md`](SECURITY.md) to confirm containment steps.

## Change Management Notes
- Document model updates in both the relevant service config (`services/tei/config.yaml`, `services/reranker/config.yaml`) and `VERSIONS.lock` before restarting services.
- Any new automation or overlay should first be described in `docs/architecture.md` and, if security-related, cross-referenced in `SECURITY.md`.
- For planned restructuring (e.g., merging `docs/architecture.md` and `docs/revision-2025-09-28.md`), log the proposal in the latter file’s “Cross-Layer Tasks” section.
